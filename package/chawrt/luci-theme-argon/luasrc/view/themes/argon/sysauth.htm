<%#
	Argon is a clean HTML5 theme for LuCI. It is based on luci-theme-bootstrap and MUI and Argon Template

	luci-theme-argon
	Copyright 2020 Jerryk <jerrykuku@gmail.com>

	Have a bug? Please create an issue here on GitHub!
	https://github.com/jerrykuku/luci-theme-argon/issues

	luci-theme-bootstrap:
	Copyright 2008 Steven Barth <steven@midlink.org>
	Copyright 2008-2016 Jo-Philipp Wich <jow@openwrt.org>
	Copyright 2012 David Menting <david@nut-bolt.nl>

	MUI:
	https://github.com/muicss/mui

	Argon Theme
	https://demos.creative-tim.com/argon-dashboard/index.html

	Licensed to the public under the Apache License 2.0
-%>

<%+themes/argon/out_header_login%>
<%
	local util		= require "luci.util"
	local fs		= require "nixio.fs"
	local nutil		= require "nixio.util"
	local json		= require "luci.jsonc"
	local sys		= require "luci.sys"
	local uci		= require 'luci.model.uci'.cursor()

	-- Fetch Local Background Media

	local function glob(...)
		local iter, code, msg = fs.glob(...)
		if iter then
			return nutil.consume(iter)
		else
			return nil, code, msg
		end
	end


	local imageTypes = " jpg png gif webp "
	local videoTypes = " mp4 webm "
	local allTypes = imageTypes .. videoTypes
	local function fetchMedia(path, themeDir)
		local backgroundTable = {}
		local backgroundCount = 0
		for i, f in ipairs(glob(path)) do
			attr = fs.stat(f)
			if attr then
				local ext = fs.basename(f):match(".+%.(%w+)$")
				if ext ~= nil then
					ext = ext:lower()
				end
				if ext ~= nil and string.match(allTypes, " "..ext.." ") ~= nil then
					local bg = {}
					bg.type = ext
					bg.url = themeDir .. fs.basename(f)
					table.insert(backgroundTable, bg)
					backgroundCount = backgroundCount + 1
				end
			end
		end
		return backgroundTable, backgroundCount
	end
	local function selectBackground(themeDir)
		local bgUrl			= media .. "/img/bg1.jpg"
		local backgroundType	= "Image"
		local mimeType			= ""

		if fs.access("/etc/config/argon") then
			local online_wallpaper = uci:get_first('argon', 'global', 'online_wallpaper') or (uci:get_first('argon', 'global', 'bing_background') == '1' and 'bing')
			if (online_wallpaper and online_wallpaper ~= "none") then
				local picurl = sys.exec("/usr/libexec/argon/online_wallpaper")
				if (picurl and picurl ~= '') then
					return picurl, "Image", ""
				end
			end
		end

		local backgroundTable, backgroundCount = fetchMedia("/www" .. themeDir .. "*", themeDir)
		if ( backgroundCount > 0 ) then
			local currentBg = backgroundTable[math.random(1, backgroundCount)]
			bgUrl			= currentBg.url
			if (string.match(videoTypes, " "..currentBg.type.." ") ~= nil) then
				backgroundType	= "Video"
				mimeType		= "video/" .. currentBg.type
			end
		end

		return bgUrl, backgroundType, mimeType
	end

	local boardinfo			= util.ubus("system", "board")
	local themeDir			= media .. "/background/"
	local bgUrl, backgroundType, mimeType = selectBackground(themeDir)
%>
<!-- Login Page Start -->
<div class="login-page">
	<% if ( backgroundType == "Video" ) then %>
	<!-- Video Player Start -->
	<div class="video">
		<video autoplay loop muted id="video">
			<source src="<%=bgUrl%>" type="<%=mimeType%>">
		</video>
	</div>
	<div class="volume-control mute"></div>
	<script>
		$(".volume-control").click(function(){
			if($(this).hasClass("mute")){
				$(this).removeClass("mute")
				$("#video").prop('muted', false);
			}else{
				$(this).addClass("mute")
				$("#video").prop('muted', true);
			}
		})
	</script>
	<!-- Video Player End -->
	<% else %>
	<!-- Image Background Start -->
	<div class="main-bg" id="main-bg" style="background-image:url(<%=bgUrl%>)"></div>
	<!-- Image Background End -->
	<% end %>
	<!-- Login Container Start -->
	<div class="login-container">
		<div class="login-form">
			<!-- Logo Start -->
			<a class="brand" href="/"><img src="<%=media%>/img/argon.svg" class="icon">
				<span class="brand-text"><%=striptags( (boardinfo.hostname or "?") ) %></span>
			</a>
			<!-- Logo End -->
			<!-- Login Form Start -->
			<form class="form-login" method="post" action="<%=pcdata(luci.http.getenv("REQUEST_URI"))%>" id="login-form">

				<%- if error_type == "rate_limited" or login_locked then %>
				<div class="lockout-message" id="lockout-message">
					<span class="lockout-icon">ğŸ”’</span>
					<div class="lockout-text">
						<strong><%:Account temporarily locked%></strong>
						<p><%:Too many failed login attempts. Please wait%> <span id="countdown"><%=lockout_remaining or 0%></span> <%:seconds before trying again.%></p>
					</div>
				</div>
				<%- elseif fuser then %>
				<div class="errorbox">
					<%:Invalid username and/or password! Please try again.%>
					<%- if failed_attempts and failed_attempts > 0 then %>
					<div class="attempts-warning">
						<%:Failed attempts:%> <%=failed_attempts%>/5
						<%- if will_lock_next then %>
						<div class="warning-next-lock">
							<%:Warning: Next failed attempt will lock your account for 2 minutes!%>
						</div>
						<%- end %>
					</div>
					<%- end %>
				</div>
				<% end -%>

				<div class="input-container">
					<div class="input-group user-icon">
						<input class="cbi-input-user" id="cbi-input-user" type="text" name="luci_username" value="<%=duser%>" <%- if login_locked then %>disabled<%- end %> />
						<label class="border" for="cbi-input-user"></label>
					</div>
					<div class="input-group pass-icon">
						<input class="cbi-input-password" id="cbi-input-password" type="password" name="luci_password" <%- if login_locked then %>disabled<%- end %> />
						<label class="border" for="cbi-input-password"></label>
					</div>
				</div>
				<div>
					<input type="submit" value="<%:Log in%>" class="cbi-button cbi-button-apply" id="login-btn" <%- if login_locked then %>disabled<%- end %> />
				</div>
			</form>
			<!-- Login Form End -->
			<style>
				.lockout-message {
					background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
					color: white;
					padding: 20px;
					border-radius: 12px;
					margin-bottom: 24px;
					display: flex;
					align-items: flex-start;
					gap: 16px;
					font-weight: 500;
					animation: pulse 2s infinite;
					box-shadow: 0 4px 15px rgba(253, 126, 20, 0.3);
				}

				.lockout-icon {
					font-size: 24px;
					margin-top: 2px;
				}

				.lockout-text strong {
					display: block;
					font-size: 16px;
					margin-bottom: 8px;
				}

				.lockout-text p {
					margin: 0;
					font-size: 14px;
					line-height: 1.4;
				}

				#countdown {
					font-weight: 700;
					font-size: 16px;
					color: #fff3cd;
					text-shadow: 0 1px 2px rgba(0,0,0,0.2);
				}

				.attempts-warning {
					margin-top: 8px;
					font-size: 13px;
					opacity: 0.9;
					font-weight: 500;
				}

				.warning-next-lock {
					margin-top: 4px;
					font-size: 12px;
					color: #ff6b6b;
					font-weight: 600;
					animation: blink 1.5s infinite;
				}

				.errorbox {
					animation: shake 0.5s ease-in-out;
				}

				@keyframes pulse {
					0%, 100% { opacity: 1; }
					50% { opacity: 0.9; }
				}

				@keyframes shake {
					0%, 100% { transform: translateX(0); }
					25% { transform: translateX(-5px); }
					75% { transform: translateX(5px); }
				}

				@keyframes blink {
					0%, 50% { opacity: 1; }
					51%, 100% { opacity: 0.7; }
				}

				.cbi-input-user:disabled,
				.cbi-input-password:disabled,
				.cbi-button:disabled {
					opacity: 0.5;
					cursor: not-allowed;
					background: rgba(255,255,255,0.3) !important;
					color: rgba(255,255,255,0.6) !important;
				}

				.unlock-message {
					background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
					color: white;
					padding: 16px 20px;
					border-radius: 12px;
					margin-bottom: 24px;
					display: flex;
					align-items: center;
					gap: 12px;
					font-weight: 500;
					animation: slideIn 0.5s ease-out;
				}

				@keyframes slideIn {
					from { transform: translateY(-20px); opacity: 0; }
					to { transform: translateY(0); opacity: 1; }
				}
			</style>

			<script type="text/javascript">//<![CDATA[
				document.addEventListener('DOMContentLoaded', function() {
					var passwordInput = document.getElementById('cbi-input-password');
					var usernameInput = document.getElementById('cbi-input-user');
					var loginForm = document.getElementById('login-form');
					var loginButton = document.getElementById('login-btn');
					var countdownElement = document.getElementById('countdown');
					var lockoutMessage = document.getElementById('lockout-message');

					// å€’è®¡æ—¶åŠŸèƒ½
					<%- if error_type == "rate_limited" or login_locked then %>
					var remainingTime = <%=lockout_remaining or 0%>;
					
					function updateCountdown() {
						if (remainingTime > 0) {
							if (countdownElement) {
								countdownElement.textContent = remainingTime;
							}
							remainingTime--;
							setTimeout(updateCountdown, 1000);
						} else {
							// å€’è®¡æ—¶ç»“æŸï¼Œå¯ç”¨è¡¨å•
							if (lockoutMessage) {
								lockoutMessage.style.display = 'none';
							}
							
							// å¯ç”¨æ‰€æœ‰è¾“å…¥
							[usernameInput, passwordInput, loginButton].forEach(function(element) {
								if (element) {
									element.disabled = false;
								}
							});
							
							// æ˜¾ç¤ºè§£é”æ¶ˆæ¯
							var unlockMessage = document.createElement('div');
							unlockMessage.className = 'unlock-message';
							unlockMessage.innerHTML = '<span style="margin-right: 8px;">âœ…</span><%:Account unlocked. You can now try to log in again.%>';
							
							if (lockoutMessage && lockoutMessage.parentNode) {
								lockoutMessage.parentNode.insertBefore(unlockMessage, lockoutMessage);
							}
							
							// 3ç§’åè‡ªåŠ¨åˆ·æ–°é¡µé¢
							setTimeout(function() {
								window.location.reload();
							}, 3000);
						}
					}
					
					updateCountdown();
					<%- end %>

					// è¡¨å•æäº¤å¤„ç†
					if (loginForm && loginButton) {
						loginForm.addEventListener('submit', function(e) {
							<%- if login_locked then %>
							e.preventDefault();
							return false;
							<%- end %>
							
							if (!loginButton.disabled) {
								loginButton.value = '<%:Logging in...%>';
								loginButton.disabled = true;
								loginButton.style.opacity = '0.7';
							}
						});
					}

					// è‡ªåŠ¨èšç„¦
					<%- if not login_locked then %>
					if (usernameInput && usernameInput.value.trim()) {
						if (passwordInput) passwordInput.focus();
					} else {
						if (usernameInput) usernameInput.focus();
					}
					<%- end %>
				});
			//]]></script>
<%+themes/argon/footer_login%>
